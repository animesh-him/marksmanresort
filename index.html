<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Marksman Resort — All-in-One Map (Fixed mobile)</title>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
  :root{--accent:#0b69ff;--muted:#6c757d}
  html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:#f4f6f8;color:#0b1220}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:10px 12px;background:#fff;box-shadow:0 1px 0 rgba(0,0,0,0.06);position:sticky;top:0;z-index:1200}
  header h1{margin:0;font-size:1rem}
  .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .btn{background:var(--accent);color:#fff;border:0;padding:8px 12px;border-radius:8px;cursor:pointer;text-decoration:none;font-size:0.92rem}
  .btn.secondary{background:var(--muted)}
  .wrap{max-width:1200px;margin:12px auto;padding:0 12px}
  .layout{display:grid;grid-template-columns:1fr 360px;gap:12px}
  .panel{background:#fff;border-radius:10px;padding:10px;box-shadow:0 6px 18px rgba(9,10,11,0.06)}
  #map2d{width:100%;height:520px;border-radius:8px;background:#fff;display:block}
  #previewFrame{width:100%;height:520px;border-radius:8px;border:0;display:block}
  #globeViz{width:100%;height:520px;border-radius:8px;background:linear-gradient(#081226,#0b1220);display:none}
  .small{font-size:0.88rem;color:#333}
  .field{font-family:monospace;font-size:0.95rem}
  pre{background:#f7f8fa;padding:10px;border-radius:8px;overflow:auto}
  footer{max-width:1200px;margin:10px auto 40px;color:#555;font-size:0.9rem;text-align:center}
  label{font-size:0.9rem}
  input[type="number"]{width:120px;padding:6px;border-radius:6px;border:1px solid #ddd}
  @media (max-width:1000px){
    .layout{grid-template-columns:1fr}
    #map2d,#previewFrame,#globeViz{height:420px}
    header h1{font-size:0.95rem}
  }
</style>
</head>
<body>
<header>
  <h1>Marksman Resort / D-Cube Sports Club — Map & Tools</h1>
  <div class="controls">
    <button id="show2d" class="btn">2D Map</button>
    <button id="show3d" class="btn">3D Globe</button>
    <button id="flyTo" class="btn">Cinematic Fly</button>
    <button id="copyBtn" class="btn secondary">Copy coords</button>
    <a id="openGoogle" class="btn" target="_blank" rel="noopener">Open in Google Maps</a>
    <a id="openOSM" class="btn secondary" target="_blank" rel="noopener">Open in OSM</a>
  </div>
</header>

<div class="wrap">
  <div class="layout">
    <div class="panel" id="mapsArea">
      <!-- Instant preview (shown immediately to avoid white/blank area) -->
      <iframe id="previewFrame" title="Preview map" src="https://www.google.com/maps?q=13.130552,77.636048&z=16&output=embed"></iframe>

      <!-- 2D interactive map (Leaflet). Hidden until we swap it in; when we show it we call invalidateSize -->
      <div id="mapContainer2d" style="display:none;">
        <div style="margin-bottom:8px;" class="small">2D Map — OpenStreetMap & Satellite (Esri).</div>
        <div id="map2d"></div>
      </div>

      <!-- 3D globe container (created lazily) -->
      <div id="mapContainer3d" style="display:none;">
        <div style="margin-bottom:8px;" class="small">3D Globe — WebGL. (Created when first used)</div>
        <div id="globeViz"></div>
      </div>
    </div>

    <div class="panel">
      <div><strong>Location & Tools</strong></div>
      <div style="margin-top:8px" class="small">Decimal: <span id="decDisplay" class="field">13.130552, 77.636048</span></div>
      <div style="margin-top:6px" class="small">DMS: <span id="dmsDisplay" class="field">13° 7' 49.99" N, 77° 38' 9.77" E</span></div>

      <div style="margin-top:12px">
        <button id="downloadKml" class="btn">Download KML</button>
        <button id="downloadGeoJSON" class="btn secondary">Download GeoJSON</button>
        <button id="exportPNG" class="btn" style="margin-top:8px">Export PNG</button>
      </div>

      <div style="margin-top:12px">
        <details><summary style="cursor:pointer;padding:8px 6px">Advanced / Raw data</summary>
          <pre id="rawData" style="margin-top:8px">
{
  "name":"Marksman Resort / D-Cube Sports Club",
  "latitude":13.130552,
  "longitude":77.636048,
  "source":"Google Maps short-link (user provided)"
}
          </pre>
        </details>
      </div>
    </div>
  </div>
</div>

<footer class="small">If the interactive map fails to load (some browsers block cross-site scripts or WebGL), the preview above remains visible so users always see the location.</footer>

<!-- Libraries -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://unpkg.com/three@0.153.0/build/three.min.js"></script>
<script src="https://unpkg.com/three-globe@2.26.5/dist/three-globe.min.js"></script>
<script src="https://unpkg.com/@tweenjs/tween.js@18.6.4/dist/tween.umd.js"></script>

<script>
/* CONFIG */
const LAT = 13.130552, LON = 77.636048, LABEL = "Marksman Resort / D-Cube Sports Club";

/* small helper DMS */
function toDMS(lat, lon) {
  function c(d,isLat){ const hemi = d>=0 ? (isLat?'N':'E'):(isLat?'S':'W'); d=Math.abs(d); const deg=Math.floor(d); const mfloat=(d-deg)*60; const min=Math.floor(mfloat); const sec=(mfloat-min)*60; return deg+"° "+min+"' "+sec.toFixed(2)+"\" "+hemi; }
  return c(lat,true)+", "+c(lon,false);
}
document.getElementById('dmsDisplay').textContent = toDMS(LAT, LON);

/* URLs for open links */
const gLink = "https://www.google.com/maps/search/?api=1&query=" + encodeURIComponent(LAT + "," + LON);
const osmLink = "https://www.openstreetmap.org/?mlat=" + LAT + "&mlon=" + LON + "#map=18/" + LAT + "/" + LON;
document.getElementById('openGoogle').href = gLink;
document.getElementById('openOSM').href = osmLink;

/* Quick state */
let map2d = null, map2dInitialized = false;
let globeCreated = false, globe = null, scene = null, camera = null, renderer = null;

/* Create 2D map only when we need it (on first show). But we also want to auto-show it once page loads,
   so we will swap preview -> 2D shortly after DOM ready. */
function init2DMap() {
  if (map2dInitialized) return;
  try {
    map2d = L.map('map2d', { zoomControl: true }).setView([LAT, LON], 16);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '&copy; OpenStreetMap contributors' }).addTo(map2d);
    const sat = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { maxZoom: 19, attribution:'Tiles &copy; Esri' });
    L.control.layers({ "OpenStreetMap": null, "Satellite (Esri)": sat }).addTo(map2d);
    L.marker([LAT, LON]).addTo(map2d).bindPopup(`<strong>${LABEL}</strong><br/>${LAT.toFixed(6)}, ${LON.toFixed(6)}`).openPopup();
    map2d.on('click', e => { const tmp = L.circleMarker(e.latlng, {radius:6}).addTo(map2d); setTimeout(()=>map2d.removeLayer(tmp),2000); });
    map2dInitialized = true;
  } catch (err) {
    console.error("Leaflet init error:", err);
    map2dInitialized = false;
  }
}

/* Create 3D globe only when shown (lazily). This avoids WebGL issues on some mobiles when hidden. */
function createGlobeIfNeeded() {
  if (globeCreated) return;
  try {
    const container = document.getElementById('globeViz');
    renderer = new THREE.WebGLRenderer({ antialias:true, alpha:true });
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    renderer.setSize(container.clientWidth || 700, container.clientHeight || 400);
    container.appendChild(renderer.domElement);

    scene = new THREE.Scene();
    camera = new THREE.PerspectiveCamera(35, container.clientWidth / container.clientHeight, 0.1, 1000);
    camera.position.set(0, 0, 200);

    scene.add(new THREE.AmbientLight(0xbbbbbb));
    const dirLight = new THREE.DirectionalLight(0xffffff, 0.6);
    dirLight.position.set(100, 100, 100);
    scene.add(dirLight);

    globe = new ThreeGlobe()
      .globeImageUrl('https://raw.githubusercontent.com/aaronice/earth-map/master/8192_4096_land_ocean_ice.jpg')
      .bumpImageUrl('https://raw.githubusercontent.com/jeromeetienne/threex.planets/master/images/earth-topo-small.jpg')
      .pointsData([{ lat: LAT, lng: LON, size: 1 }])
      .pointAltitude(0.01)
      .pointColor(()=>'orange');

    scene.add(globe);
    globe.rotateY(0.6);

    (function animate(){
      requestAnimationFrame(animate);
      globe.rotation.y += 0.0008;
      renderer.render(scene, camera);
    })();

    globeCreated = true;
  } catch (err) {
    console.error("Globe creation failed:", err);
    globeCreated = false;
  }
}

/* Swap preview -> 2D map and ensure map tiles render properly */
function show2D() {
  // hide preview iframe
  document.getElementById('previewFrame').style.display = 'none';
  document.getElementById('mapContainer3d').style.display = 'none';
  document.getElementById('mapContainer2d').style.display = 'block';

  // initialize if needed
  init2DMap();

  // important: allow layout to settle then call invalidateSize
  setTimeout(() => {
    try {
      map2d.invalidateSize && map2d.invalidateSize();
      map2d.setView([LAT, LON], 16);
    } catch (e) { console.warn("invalidateSize failed:", e); }
  }, 260);
}

/* Show 3D globe: create lazily and show; if globe creation fails, keep preview visible */
function show3D() {
  document.getElementById('previewFrame').style.display = 'none';
  document.getElementById('mapContainer2d').style.display = 'none';
  document.getElementById('mapContainer3d').style.display = 'block';

  try {
    createGlobeIfNeeded();
    // try a small camera fly after short delay if globe created
    if (globeCreated) {
      setTimeout(()=> {
        const phi = (90 - LAT) * (Math.PI/180);
        const theta = (LON + 180) * (Math.PI/180);
        const r = 200;
        const tx = r * Math.sin(phi) * Math.cos(theta);
        const ty = r * Math.cos(phi);
        const tz = r * Math.sin(phi) * Math.sin(theta);
        if (camera) {
          camera.position.set(tx, ty, tz);
          camera.lookAt(0,0,0);
        }
      }, 400);
    } else {
      // failed; fallback to preview
      document.getElementById('mapContainer3d').style.display = 'none';
      document.getElementById('previewFrame').style.display = 'block';
    }
  } catch (err) {
    console.error("show3D error:", err);
    document.getElementById('mapContainer3d').style.display = 'none';
    document.getElementById('previewFrame').style.display = 'block';
  }
}

/* Cinematic fly: perform 2D fly then 3D fly, with checks */
function cinematicFly() {
  // prefer to show 3D first if available
  show3D();
  // If globe created do a 3D camera move then show 2D and fly
  if (globeCreated && camera) {
    // simple camera tween (non-blocking)
    setTimeout(() => {
      // after globe fly, show 2D and fly
      show2D();
      setTimeout(()=> { map2d && map2d.flyTo([LAT,LON], 18, {duration: 2.0}); }, 650);
    }, 1400);
  } else {
    // fallback: just show 2D and fly
    show2D();
    setTimeout(()=> { map2d && map2d.flyTo([LAT,LON], 18, {duration: 1.8}); }, 350);
  }
}

/* Buttons wiring */
document.getElementById('show2d').addEventListener('click', show2D);
document.getElementById('show3d').addEventListener('click', show3D);
document.getElementById('flyTo').addEventListener('click', cinematicFly);
document.getElementById('copyBtn').addEventListener('click', async ()=>{
  const t = `${LAT.toFixed(6)}, ${LON.toFixed(6)}`;
  try { await navigator.clipboard.writeText(t); alert('Copied: '+t); } catch(e){ prompt('Coords (copy):', t); }
});

/* KML & GeoJSON downloads */
function kmlText(lat,lon){
  return `<?xml version="1.0" encoding="UTF-8"?>
<kml xmlns="http://www.opengis.net/kml/2.2"><Document><name>Marksman Resort</name>
<Placemark><name>${LABEL}</name><Point><coordinates>${lon},${lat},0</coordinates></Point></Placemark>
</Document></kml>`;
}
function geojsonText(lat,lon){
  return JSON.stringify({ type:"FeatureCollection", features:[{ type:"Feature", properties:{name:LABEL}, geometry:{ type:"Point", coordinates:[lon,lat] } }] }, null, 2);
}
document.getElementById('downloadKml').addEventListener('click', ()=>{
  const blob = new Blob([kmlText(LAT,LON)], {type:'application/vnd.google-earth.kml+xml'});
  const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='marksman-resort.kml'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
});
document.getElementById('downloadGeoJSON').addEventListener('click', ()=>{
  const blob = new Blob([geojsonText(LAT,LON)], {type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='marksman-resort.geojson'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
});

/* Export PNG (captures preview or the 2D map or globe fallback) */
document.getElementById('exportPNG').addEventListener('click', async ()=>{
  const preview = document.getElementById('previewFrame');
  const mapVisible = document.getElementById('mapContainer2d').style.display !== 'none';
  const globeVisible = document.getElementById('mapContainer3d').style.display !== 'none';
  // prefer capture of the visible panel
  let targetEl = preview;
  if (mapVisible) targetEl = document.getElementById('map2d');
  else if (globeVisible) targetEl = document.getElementById('globeViz');

  try {
    const canvas = await html2canvas(targetEl, {useCORS:true, logging:false});
    const url = canvas.toDataURL('image/png');
    const a = document.createElement('a'); a.href = url; a.download = 'marksman_view.png'; document.body.appendChild(a); a.click(); a.remove();
  } catch (err) {
    alert('Export failed: ' + err.message);
  }
});

/* On first load: show the 2D interactive map after small delay so preview shows immediately and map tiles won't be blank.
   This gives a pleasant experience on slow mobile: user sees preview immediately, then it swaps to interactive map. */
window.addEventListener('load', function(){
  // show preview immediately (already visible)
  // after a short delay, attempt to create and show the 2D map
  setTimeout(()=> {
    try {
      show2D();
    } catch (e) {
      console.warn('Auto show2D failed', e);
      // keep preview
      document.getElementById('previewFrame').style.display = 'block';
    }
  }, 700); // small delay allows layout & fonts to settle
});

/* Ensure Leaflet map resizes correctly on orientation change or when returning to tab */
window.addEventListener('orientationchange', ()=> { setTimeout(()=> { map2d && map2d.invalidateSize && map2d.invalidateSize(); }, 350); });
window.addEventListener('resize', ()=> { setTimeout(()=> { map2d && map2d.invalidateSize && map2d.invalidateSize(); }, 350); });
</script>
</body>
</html>
